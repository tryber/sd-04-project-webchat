<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Webchat</title>
  </head>

  <body>
    <form id="nickname-form">
      <input
        type="text"
        id="nickname"
        placeholder="Type your nickname"
        data-testid="nickname-box"
      />
      <button class="nickname-save" data-testid="nickname-save">Save</button>
    </form>
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input
        type="text"
        id="message"
        placeholder="Enter message"
        required
        data-testid="message-box"
      />
      <button data-testid="send-button">Send</button>
    </form>
    <button id="public-button" data-testid="public" disabled>Public</button>
    <ul id="users-list"></ul>

    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
      const form = document.getElementById('chat-form');
      const chatMessages = document.getElementById('chat-messages');
      const nicknameForm = document.getElementById('nickname-form');
      const userList = document.getElementById('users-list');
      const publicButton = document.getElementById('public-button');

      const socket = io();
      const localHistory = {
        public: [],
        private: [],
      };
      let nickname;
      let receiver;
      let chatType = 'public';

      const add = (message) => {
        const messageElement = document.createElement('p');
        messageElement.setAttribute('data-testid', 'message');
        messageElement.innerText = message;
        chatMessages.appendChild(messageElement);
      };

      const clear = () => {
        while (chatMessages.firstChild) {
          chatMessages.removeChild(chatMessages.lastChild);
        }
      };

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const chatMessage = event.target.elements.message.value;
        socket.emit('message', { chatMessage, nickname, receiver });
        event.target.elements.message.value = '';
        event.target.elements.message.focus();
      });

      nicknameForm.addEventListener('submit', (event) => {
        event.preventDefault();
        nickname = event.target.elements.nickname.value;
        socket.emit('updateNick', nickname);
      });

      publicButton.addEventListener('click', (_event) => {
        publicButton.disabled = true;
        clear();
        chatType = 'public';
        receiver = '';
        localHistory.public.map((m) => add(m));
      });

      socket.on('connect', () => {
        if (!nickname) nickname = `Guest_${socket.id}`;
        socket.emit('userConnection', nickname);
      });

      socket.on('displayHistory', (history, type) => {
        let msg;
        if (type === 'public') {
          history.map(({ timestamp, nickname, message }) => {
            msg = `${timestamp} - ${nickname}: ${message}`;
            localHistory[type].push(msg);
            if (type === chatType) add(msg);
          });
        } else {
          history.map(({ timestamp, nickname, message, receiver }) => {
            msg = `${timestamp} (private) - ${nickname}: ${message}`;
            localHistory[type].push(msg);
            if (type === chatType) add(msg);
          });
        }
      });

      socket.on('displayUsers', (users) => {
        userList.innerHTML = '';
        Object.entries(users).map(([key, value]) => {
          const li = document.createElement('li');
          const div = document.createElement('div');
          div.innerText = `${value}`;
          div.setAttribute('data-testid', 'online-user');
          li.appendChild(div);
          if (key !== socket.id) {
            const privateButton = document.createElement('button');
            privateButton.innerText = 'Private';
            privateButton.id = key;
            privateButton.setAttribute('data-testid', 'private');
            privateButton.addEventListener('click', (event) => {
              clear();
              publicButton.disabled = false;
              chatType = 'private';
              receiver = event.target.id;
              localHistory.private.map((m) => add(m));
            });
            li.appendChild(privateButton);
          }
          userList.appendChild(li);
        });
      });

      socket.on('message', (message, type) => {
        localHistory[type].push(message);
        console.log(localHistory);
        if (type === chatType) add(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    </script>
  </body>
</html>
