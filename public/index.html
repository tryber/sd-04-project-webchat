<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="css/style.css" />
    <title>WebChat</title>
  </head>
  <body>
    <div class="main-container">
      <h1 class="title">($) Web Chat ($)</h1>
      <div class="dynamic-container">
        <div class="side-bar">
          <h3 class="text">Me:</h3>
          <p id="user-name" class="text"></p>
          <form id="name-form">
            <input
                id="name"
                type="text"
                autocomplete="off"
                class="text"
                required
                placeholder="Name"
                data-testid="nickname-box"
            />
            <button class="btn text"data-testid="nickname-save">Save</button>
          </form>
          <h3 class="text">Users Online:</h3>
          <ul id="users"></ul>
          <button class="btn text" data-testid="public" id="public-btn">Public</button>
        </div>
        <div class="main-chat-container">
          <div class="chat-container"></div>
          <div class="chat-form-container">
            <form id="chat-form">
              <input
                id="msg"
                type="text"
                placeholder="Enter Message"
                required
                autocomplete="off"
                class="text input-chat"
                data-testid="message-box"
              />
              <button class="btn btn-chat text" data-testid="send-button">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const chatInput = document.getElementById('chat-form');
      const chatMessages = document.querySelector('.chat-container');
      const nameInput = document.getElementById('name-form');
      const nameP = document.getElementById('user-name');
      const userList = document.getElementById('users');
      const publicBtn = document.getElementById('public-btn');

      const socket = io();
      let nickname = 'Zelda';
      let state = 'global';
      let target = '';
      const histPriv = [];

      function OutputMessage(message) {
        const div = document.createElement('div');
        div.innerHTML = `
        <p class="text" data-testid="message">
          ${message}
        </p>`;

        chatMessages.appendChild(div);
      }

      const stateChange = (newState) => {
        console.log(newState);
        state = newState;
        socket.emit('stateJoin', state);
      }

      const clearMessages = () => {
        while (chatMessages.firstChild) {
          chatMessages.removeChild(chatMessages.firstChild);
        }
      }

      function OutputUsers(users) {
        userList.innerHTML = '';
        const usersKeys = Object.keys(users);
        usersKeys.forEach((userKey) => {
          console.log(users[userKey].nickname);
          const li = document.createElement('li');
          const div = document.createElement('div');
          div.innerText = `${users[userKey].nickname}`
          div.setAttribute('class', 'text');
          div.setAttribute('data-testid', 'online-user');
          li.appendChild(div);
          if (users[userKey].nickname !== nickname) {
            const privateBtn = document.createElement('button');
            privateBtn.setAttribute('class', 'text');
            privateBtn.setAttribute('data-testid', 'private');
            privateBtn.innerText = 'private';
            privateBtn.id = userKey;
            privateBtn.addEventListener('click', (event) => {
              clearMessages();
              publicBtn.disabled = false;
              //chatType = 'private';
              target = event.target.id;
              histPriv.map(message => OutputMessage(message));
            });
            li.appendChild(privateBtn);
          }
          userList.appendChild(li);
        });
      }

      socket.emit('start');

      socket.on('message', (message, style) => {
        //  console.log(message);
        if (style === 'private') histPriv.push(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        OutputMessage(message);
      });

      socket.on('roomUsers', ({ users }) => {
        //  console.log(users);
        OutputUsers(users);
      });

      socket.on('history', (hist) => {
        hist.forEach((message) => {
          OutputMessage(`${message.date} - ${message.nickname}: ${message.chatMessage}`);
        });
      });

      chatInput.addEventListener('submit', (e) => {
        e.preventDefault();

        const msg = e.target.elements.msg.value;

        socket.emit('message', { chatMessage: msg, nickname, state });

        e.target.elements.msg.value = '';
      });

      nameInput.addEventListener('submit', (e) => {
        e.preventDefault();

        const name = e.target.elements.name.value;
        nameP.innerHTML = name;
        nickname = name;

        socket.emit('nameChange', name);

        e.target.elements.name.value = '';
      });

      publicBtn.addEventListener('click', () => stateChange('global'));

    </script>
  </body>
</html>