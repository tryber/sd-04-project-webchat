<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Project WebChat</title>
  </head>
  <script></script>
  <body>
    <h1>Welcome to WebChat Project</h1>
    <p id="nicknameValue">${nicknameInput}</p>
    <div>
      <h2>Logged Users</h2>
      <ul id="loggedUserList"></ul>
    </div>
    <div>
      <h2>Messages</h2>
      <ul id="messagesList"></ul>
      <div>
        <label> Type your Nickname </label>
        <input
          data-testid="nickname-box"
          id="nicknameInput"
          type="text"
          name="nicknameInput"
        />
        <button data-testid="nickname-save" id="nicknameButton">
          use your nickname
        </button>
      </div>
    </div>
    <form action="">
      <input id="messageInput" data-testid="message-box" type="text" />
      <button data-testid="send-button">Send your message</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const form = document.querySelector('form');
      const input = document.getElementById('messageInput');
      let nicknameInput = document.getElementById('nicknameInput');
      let loggedUserList = document.getElementById('loggedUserList');
      let messagesList = document.getElementById('messagesList');
      let nicknameValue = document.getElementById('nicknameValue');
      let nickname = '';

      // On load set a default nickname
      function defaultNickname() {
        socket.on('connect', () => {
          console.log('nickname', socket.id);
          nicknameValue.innerHTML = socket.id;
          nickname = socket.id;
          socket.emit('send all messages');

          //   socket.emit('message', {
          //   text: 'just send all messages',
          // });
        });
      }

      // Change the nickname after click and clean the input
      document
        .getElementById('nicknameButton')
        .addEventListener('click', getNickname, false);

      function getNickname() {
        nickname = nicknameInput.value;
        nicknameValue.innerHTML = nickname;
        nicknameInput.value = '';
        socket.emit('nicknameChange', {
          socketId: socket.id,
          nickname,
        });
      }

      // Start socket.io connection
      const socket = io();

      // Send message after click and clean the input
      function sendMessage(e) {
        e.preventDefault(); // prevent if f5 on the page
        // send input value to server as type 'message'
        socket.emit('message', {
          chatMessage: input.value,
          nickname,
        });
        input.value = '';
      }

      form.addEventListener('submit', sendMessage);

      function updateLoggedUsersList(loggedUsers) {
        loggedUserList.innerHTML = '';

        Object.keys(loggedUsers).map(function (key) {
          let li = document.createElement('li');
          li.innerText = loggedUsers[key];
          li.setAttribute('data-testid', 'online-user');
          loggedUserList.appendChild(li);
        });
      }

      function addMessageToHTML(message) {
        // messagesList.innerHTML = '';
        let li = document.createElement('li');
        li.innerText = message;
        li.setAttribute('data-testid', 'message');
        messagesList.appendChild(li);
      }

      function updateAllMessages(message) {
        messagesList.innerHTML = '';
        for (let index = 0; index < message.length; index++) {
          let li = document.createElement('li');
          li.setAttribute('data-testid', 'message');
          let time = message[index].created_on;
          li.innerText = `${time} - ${message[index].nickname}: ${message[index].chatMessage}`;
          messagesList.appendChild(li);
        }
      }
      socket.on('message', addMessageToHTML);
      socket.on('loggedUsers', updateLoggedUsersList);
      socket.on('allMessages', updateAllMessages);

      window.onload = defaultNickname;
    </script>
  </body>
</html>
