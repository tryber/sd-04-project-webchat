<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webchat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://chancejs.com/chance.min.js"></script>
  </head>
  <body>
    <h1 id="userName"></h1>

    <input data-testid="nickname-box" type="text" id="nickInput" />
    <button id="changeNick" data-testid="nickname-save">Save nickname</button>

    <ul id="listMessage"></ul>

    <input data-testid="message-box" id="textInput" autocomplete="off" />
    <button id="sendMessage" data-testid="send-button">Send</button>

    <ul id="usersConnected"></ul>

    <button data-testid="public">Public</button>

  </body>
  <script>
    const socket = io();

    const user = document.querySelector('#userName');

    const chatMessageInput = document.querySelector('#textInput');
    const nicknameInput = document.querySelector('#nickInput');

    const nickBtn = document.querySelector('#changeNick');
    const messageBtn = document.querySelector('#sendMessage');

    const onlineUsers = document.querySelector('#usersConnected');
    const messages = document.querySelector('#listMessage');

    window.onload = () => {
      user.innerText = chance.first();
      let nickname = user.innerText;

      socket.emit('newNickName', { nickname });

      nickBtn.addEventListener('click', (event) => {
        event.preventDefault();
        nickname = nicknameInput.value;
        user.innerText = nickname;

        socket.emit('newNickName', { nickname });
      });

      messageBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const chatMessage = chatMessageInput.value;

        socket.emit('message', { nickname, chatMessage });
      });

      socket.on('userList', async (data) => {
        onlineUsers.innerHTML = await data
          .map(
            (users) => `<li data-testid="online-user">${users}</li>
          ${users === nickname ? '' : `<button id=${users} data-testid="private">Private</button>`}`,
          )
          .join(' ');
      });

      socket.on('history', (data) => {
        messages.innerHTML = data
          .map((msg) => `<li data-testid="message">${msg.message}</li>`)
          .join('');
      });

      socket.on('message', (data) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'message');
        li.textContent = data;

        messages.appendChild(li);
      });
    };

  </script>
</html>